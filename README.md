# サークル棟 鍵貸し出しシステム

大学のサークル棟での鍵貸し出しを管理するWebシステムです。学生証のバーコードから学籍番号を読み取り、所属団体の部室の鍵を貸し出すことができます。

## 機能

### ユーザー画面
- 学生証バーコード読み取り
- 学籍番号から所属団体を自動表示
- 部屋選択と鍵貸出
- 現在貸出中の鍵一覧表示
- 鍵の返却機能

### 管理者画面
- CSV一括登録（学生・所属情報）
- 団体管理（追加・一覧表示）
- 貸出中の鍵一覧
- 貸出履歴表示
- 団体・学生データの一括削除（リセット機能）

## セットアップ

### 1. 依存パッケージのインストール

```bash
npm install
```

### 2. サーバーの起動

```bash
npm start
```

開発モード（自動再起動）で起動する場合:

```bash
npm run dev
```

### 3. アクセス

- ユーザー画面: http://localhost:3000
- 管理者画面: http://localhost:3000/admin.html

### 4. サーバーの停止

サーバーが動いているターミナルで **`Ctrl + C`** を押します。

バックグラウンドで起動している場合は以下のコマンドで停止:

```bash
lsof -ti :3000 | xargs kill -9
```

## 使い方

### 初期設定（管理者画面）

1. 管理者画面にアクセス
2. 「団体管理」タブで団体を登録
   - 団体名と部屋番号を入力
   - 登録すると団体IDが自動で割り振られます
3. 団体IDをメモしておく

### CSV一括登録（学生）

1. 管理者画面の「CSV一括登録」タブを開く
2. 以下の形式のCSVファイルを用意:

```csv
student_id,name,email,org_id,role
S2024001,山田太郎,yamada@example.com,1,代表
S2024002,佐藤花子,sato@example.com,1,一般会員
```

**CSV列の説明:**
- `student_id` (または `学籍番号`): 学生の学籍番号
- `name` (または `氏名`): 学生の氏名
- `email` (または `メール`): メールアドレス（任意）
- `org_id` (または `団体ID`): 所属団体のID（団体管理で確認）
- `role` (または `役職`): 役職（任意、デフォルト: 一般会員）

3. CSVファイルをアップロード

### CSV一括登録（団体）

1. 管理者画面「団体管理」タブ内の「CSVで団体を登録」を開く
2. 以下の形式のCSVファイルを用意:

```csv
org_id,org_name,room_number,can_use_practice_rooms,storage_ids
4,写真部,203,0,
5,軽音楽部,302,1,"1,2"
```

**CSV列の説明:**
- `org_id` (任意): 団体ID。空欄の場合は自動採番
- `org_name`: 団体名（必須）
- `room_number`: 部室番号（任意）
- `can_use_practice_rooms`: 練習場の利用可否（1/0, true/false, はい/いいえ等）
- `storage_ids`: 利用可能な倉庫IDをカンマ・スペース・セミコロン区切りで指定（任意）

3. CSVファイルをアップロード

### 鍵の貸出（ユーザー画面）

1. ユーザー画面にアクセス
2. バーコードリーダーで学生証をスキャン（または学籍番号を入力）
3. 所属団体が表示されるので、借りる部屋を選択
4. 確認画面で「確定」をクリック
5. 鍵が貸し出されます

### 鍵の返却

- ユーザー画面または管理者画面の貸出中一覧から「返却」ボタンをクリック

## データベース構造

- `students`: 学生情報
- `organizations`: 団体情報
- `memberships`: 学生と団体の所属関係
- `rental_logs`: 鍵の貸出履歴

データベースファイルは `data/key_rental.db` に自動作成されます。

## 技術スタック

- **バックエンド**: Node.js, Express
- **データベース**: SQLite (better-sqlite3)
- **フロントエンド**: HTML, CSS, JavaScript
- **その他**: CSV-parser, Multer

## サンプルデータ

プロジェクトに含まれる `sample-csvs/sample-members.csv` を使ってテストできます。

- 団体ID 1: シャンソン研究会 (部室 B101, 倉庫1, 練習場利用可)
- 団体ID 2: 應援指導部 (部室 105, 倉庫6, 練習場利用可)
- 団体ID 3: マンドリンクラブ (部室 201, 倉庫3, 練習場利用不可)

必要に応じて団体名/部屋/倉庫割り当てを管理者画面で設定し、CSV内の `org_id` と一致させてください。

## 注意事項

- バーコードリーダーは学籍番号を直接入力するタイプを想定しています
- 学籍番号はバーコードと対応している必要があります
- データは `data/` ディレクトリに保存されます
- アップロードされたCSVは処理後、自動削除されます
- 団体・学生データを全削除する場合は、管理者画面「団体管理」タブ内のリセットボタンを利用できます。実行後は復元できないため、必要に応じて事前にバックアップを取得してください
